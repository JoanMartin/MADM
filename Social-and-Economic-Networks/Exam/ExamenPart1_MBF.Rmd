---
title: "Examen Final - 1a Part"
subtitle: '**Xarxes Socials i Econòmiques**'
author: Maria del Mar Bibiloni Femenias
output:
  html_document:
    number_sections: false
    theme: default
    toc: yes
    highlight: tango
    df_print: paged
editor_options: 
  chunk_output_type: inline
---


<style type="text/css">
  
  a:link {
    color: #0174DF;
  }
  
  code.r {
    font-size: 14px;
  } 
  
  div pre {
    background-color:#E0ECF8;
  }
  pre {
    font-size: 14px 
  }
 
  p {
    text-align: justify;
  }
 
  h1, h2, h3, h5, h6 {
    color: #088A85;
  }

  th {  
    background-color:#088A85;
    color: #FAFAFA;
    padding:5px;
  }
  
  td {
    font-size: 11.5pt;
  } 
  
  tr:nth-child(even){
    background: white;
  }
  
  tr:nth-child(odd){ 
    background-color: #EFF8FB;
  }
</style>


****
<br>
```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=8, fig.height=8, fig.align="center", echo=TRUE, warning=FALSE, message=FALSE,autodep = TRUE,cache=TRUE)
setwd('C:/Users/maria/Documents/UIB/MADM/1rSemestre/XarxesSocialsEconomiques/Examen/')
library(knitr)
library(printr)
library(statnet)
library(igraph)
```

###Exercice 1
**1)** (**2 points**) *Do Exercise 7 in Chapter 3 (pages 95–97) in Easley-Kleinberg’s "Networks, Crowds, and Markets" (you have a copy of the book in the course’s Virtual Classroom).*

**Pendent Pasar a net.**

<br>

###Exercice 2
**2)** (**2 points**) *Let V be a partition of an undirected graph $G$. For every community $X_r\in \mathcal{V}$, let $a_r$ be the fraction of edges incident to nodes in $X_r$, and for every $Xr,Xs \in \mathcal{V}$, let $e_{r,s}$ be the fraction of edges in $G$ that link nodes in $X_r$ with nodes in $X_s$.*

<ul>
**(a)** *Write an expression for the modularity $Q(\mathcal{V})$ of the partition $\mathcal{V}$ in terms of these quantities ar and $e_{r,s}$.*

**Pendent Pasar a net.**


**(b)** *In the AMEN (AIDS in Multi-Ethnic Neighborhoods) study (1992), the following frequencies of ethnicities in a large sample of heterosexual couples in San Francisco were recorded.*

<br>
<center>
|                 |           | |              | |           |           | |           |
|-----------------|-----------|-|--------------|-|-----------|-----------|-|-----------|
|                 |           | |              | |**Women**  |           | |           |
|    **Men**      |&nbsp;**Black**  |&nbsp;| &nbsp; **Hispanic** |&nbsp;| &nbsp;**White** | **Other** |&nbsp;| &nbsp;**Total** |
| **Black**       |&nbsp; 0.258     | |&nbsp; 0.016        | | 0.035     | &nbsp;0.013     | | &nbsp;0.323     |
| **Hispanic**    |&nbsp; 0.012     | | &nbsp; 0.157        | | 0.058     | &nbsp;0.019     | | &nbsp;0.247     |
| **White**       |&nbsp; 0.013     | | &nbsp; 0.023        | | 0.306     | &nbsp;0.035     | | &nbsp;0.377     |
| **Other**       |&nbsp; 0.005     | | &nbsp; 0.007        | | 0.024     | &nbsp;0.016     | | &nbsp;0.053     |
| **Total**       |&nbsp; 0.289     | | &nbsp; 0.204        | | 0.423     | &nbsp;0.084     | |           |
</center>
<br>
*Consider the undirected network of relationships for the sample studied and the partition defined by the nodes’ ethnicity (black, hispanic, white, and other). Compute the modularity of this partition. Assuming that the sample was representative of their community, what can you conclude about ethnic homophily in this community?*

Donada la informació de la taula, emprarem la fórmula en **a)** per calcular la modularitat. Si ens fixa'm, a la diagonal de la taula tenim la fracció d'arestes en el graf que junten nodes de la mateixa ètnia, per tant, $e_{r,r}$. Ara considerem, per exemple, la primera fila; el primer valor es $e_{B,B}$, el segon ens indica la fracció de dones hispàniques que són la parella d'un home negre i els següents el mateix per la corresponent ètnia. D'aquesta manera, si sumam tots els valors de la fila, llevat el valor en la diagonal, tindem la fracció de dones no negres que tenen un home negre. En altres paraules, la fracció d'arestes incidents a nodes de la ètnia negre, $a_B$.

Per tant, podem calcular la modularitat tal com segueix.

Introduïm la matriu amb les dades.
```{r}
M=matrix(c(0.258, 0.016, 0.035, 0.013,
       0.012, 0.157, 0.058, 0.019,
       0.013, 0.023, 0.306, 0.035,
       0.005, 0.007, 0.024, 0.016), byrow=TRUE, nrow=4,ncol=4)
print(M)
```

Calculam tots els $e_{r,r}$ i $a_r^2$.
```{r}
#Vector (eBB, eHH, eWW, eOO)
err=diag(M)
print(err)
#Vector (aB^2, aH^2, aW^2, aO^2)^T
ar=( (M-diag(diag(M)))%*%c(1,1,1,1) )^2
print(ar)
```

Sumam, i obtenim la modularitat.

```{r}
modularity=sum(err)+sum(ar)
modularity
```

La modularitat obtinguda és gran (>0.7), per tant, hi ha indicis d'una estructura dividida per ètnies; suposant que la mostra és representativa per cada comunitat. En alres paraules, hi ha certa tendència a que els matrimonis es fasin entre persones de la mateixa ètnia.

</ul>
<br>

###Exercice 3
**3)** (**2 points**) *Consider the configuration model where a fraction $p_1$ of nodes have degree $1$ and the remaining fraction of nodes $p_3 = 1-p_1$ have degree $3$. Let us consider, to fix ideas, networks of order $n = 10^4$.*

<ul>
**(a)** *Take first $p_1 = 0.5$, $p_3 = 0.5$. Estimate through a simulation the expected fraction of a network of order $n = 10^4$ covered by its largest component.*

Volem crear una mostra de grafs aleatòris que segueixin un model de configuració amb la meitat dels nodes $1$ i la meitat $3$; ja que prenem $p_1=p_2=0.5$. Així, cream la distrubució de graus del nostre graf d'orde $n = 10^4$ tal com segueix.
```{r}
degreeDist=c(rep(1, (10^4)/2), rep(3, (10^4)/2)) 
```

Ara, ja podem introduir la distribució de graus a *sample_degseq* i obtenir una mostra amb la mida de ma major component conexa de cada graf. Una vegada tinguem aquest valor, podem calcular la mitjana de la mida.
```{r}
N=1000
sample=replicate (N, sort(components(sample_degseq(degreeDist, method="simple.no.multiple"))$csize,decreasing = TRUE)[1])

#expected fraction covered by its largest component
E_L1=mean(sample)/10^4
E_L1
```

Com podem observar, la major part dels nodes formen part de la major component connexa.

**(b)** *Now, plot a graph of the expected fraction (estimated through simulations) of a network of order $n = 10^4$ covered by its largest component for values of $p_1$ from $0$ to $1$ in $0.01$ steps. According to your graph, what is the probability $p_1$ at which the giant component disappears? Is your estimate consistent with the theory?*

En aquest apartat, calcularem la fracció que representa la component connexa més gran esperada per diversos valors de $p_1$, de forma anàloga a l'apartat anterior. Guardam els valors esperats obtinguts per a cada $p_1$ a la variable *EL1_list*. De la mateixa manera, guardarem la mida relativa esperada de la segona major component a la variable *EL2_list*, i així podrem comparar les mides.


```{r, results='hide', fig.height=5}
N=100
EL1_list=c()
EL2_list=c()
for( p in seq(0,1,by=0.01)){
  cat(p/0.01," ")
  #Distribució per cada p
  degreeDist=c( rep(1, floor(p*(10^4)) ), rep(3, 10^4-floor(p*(10^4)) ) )
  #Cream les mostres i guardam la esperança de L1 i L2
  sample_L1=c()
  sample_L2=c()
  for(i in 1:N){
    components=sort(components(sample_degseq(degreeDist,
                  method="simple.no.multiple"))$csize,decreasing = TRUE)
    L1=components[1]
    L2=components[2]
    sample_L1=c(sample_L1,L1)
    sample_L2=c(sample_L2,L2)
  }
  EL1_list=c(EL1_list,mean(sample_L1)/10^4)
  EL2_list=c(EL2_list,mean(sample_L2)/10^4)
}
```

A continuació, dibuixam els valors esperats en funció de $p_1$ per cada una de les components.

```{r, fig.align='center'}
plot(seq(0,1,by=0.01),EL1_list, xlab = "p1",ylab = "Expected fraction", ylim = c(0,1),
     pch=21, col="green4", bg="mediumspringgreen")
par(new=TRUE)
plot(seq(0,1,by=0.01),EL2_list,xlab = "p1",ylab = "Expected fraction",ylim = c(0,1),
     pch=21, col="blue", bg="deepskyblue")
abline(v=0.63, col="lightcoral")
legend("topright", inset=.02, c("L1","L2"), col=c("green4","deepskyblue"), pch=c(19,19), cex=0.8)
```

Si ens fixa'm només a la gràfica de L1, tenim que partir de $p_1=0.75$, aproximadament, no hi ha gaire diferència en el nombre esperat de nodes de les dues components majors del graf. Per tant, aquí ja no hi ha cap dubte de que la component connexa gegant ha desaparegut.

La teoria ens diu que, si $E(\mbox{deg}^2)>2E(\mbox{deg})$, el graf té una component connexa gegant i les altres components tenen ordre com a molt $log(10^4)\approx 9$, això és de l'ordre de $10^-3$ en termes relatius. Vegem fin quina $p_1$ es dóna la condició.

Sigui $P_d(k)$ la distribució dels graus, és a dir, la fracció de nodes de grau $k$, tenim que $P_d(1)=p_1$ i $P_d(3)=p_3=1-p_1$. A més, considerem $n_1$ el nombre de nodes de grau $1$ i $n_3$ el nombre de nodes de grau $3$.  Així,
$$
\begin{array}{rcllcl}
2E(\mbox{deg})&=& \displaystyle 2 \sum_{k} k\cdot P_d(k) &=& \displaystyle\ 2\left[ \sum_{k=1}^{n_1} 1p_1 +  \sum_{k=1}^{n_3} 3(1-p_1) \right] = 2n_1p_1 + 6n_3(1-p_1),\\
E(\mbox{deg}^2)&=& \displaystyle 2 \sum_{k} k^2\cdot P_d(k) &=& \displaystyle 2\left[ \sum_{k=1}^{n_1} 1p_1 +  \sum_{k=1}^{n_3} 9(1-p_1) \right] = n_1p_1 + 9n_3(1-p_1). 
\end{array}
$$

Ara, teim que $n_1=p_110^4$ i $n_3=10^4(1-p_1)$. Per tant,

$$
\begin{array}{rcl}
2E(\mbox{deg})&=& \displaystyle 2\cdot10^4(p_1^2 + 3(1-p_1)^2),\\
E(\mbox{deg}^2)&=& 10^4(p_1^2 + 9(1-p_1)^2) \displaystyle .
\end{array}
$$

Volem veure fins quin $p_1$ es satisfà $E(\mbox{deg}^2)>2E(\mbox{deg})$, equivalentment $E(\mbox{deg}^2)-2E(\mbox{deg})>0$. En termes de $p_1$ es

$$
E(\mbox{deg}^2)-2E(\mbox{deg})= 2p_1^2 - 6p_1 + 2p_1^2 > 0.
$$

Així, si estudiam el signe del polinomi $2p_1^2 - 6p_1 + 2p_1^2$ obtenim que entre $p_1=0$ i $ p_1=\frac{3-\sqrt{3}}{2}\approx0.634$ és positiu, per tant, existeix component connexa gegant.

D'aquesta manera, pels pasos $p$ agafats en la simulació, hauriem d'obtenir que hi ha component connexa gegant almenys fins el $0.063$. Així, s'ha dibuixat la línea vertical vermella en $p_1=0.063$ i, com s'observa, la component connexa major té gairebé el $60\%$ dels nodes, mentre que la fracció esperada de la segona està molt pròxima al $0$ (per d'alt). D'aquesta manera, si consideram força gran el $55\%$ dels nodes, com l'ordre de la segona major component es tan petit, tenim que la simulació s'ajusta amb la teoria, ja que fins $p_1=0.063$ hi ha component connexa gegant, i després la fracció de nodes de la primera component disminueix ràpidament el seu valor.

</ul>

<br>

###Exercice 4
**4)** (**4 points**) *Stochastic models can be used to predict links in a network. Now, in a homework you were asked to produce an ERGM of Grey’s Anatomy sexual contact network. Using your model (or a friend’s, if you did not deliver this homework):*

Abans de respondre els apartats següents, recordem el model ERG emprat per les relacions de _Grey's Anatomy_.


Carregam les dades dels personatges de la sèrie i cream la xarxa amb els seus atributs, tal com es va fer al Handout 8.
```{r}
GA_nodes=read.table("GA_nodes.txt", header=TRUE)
GA_edges=read.table("GA_edges.txt")

#Cream graf.
GA=graph_from_data_frame(GA_edges, directed = FALSE)

#Afegim els atributs.
order=as.numeric(V(GA)$name)

V(GA)$label<-as.character(GA_nodes$name)[order]
V(GA)$name<- as.character(GA_nodes$name)[order]
V(GA)$sex<-as.character(GA_nodes$sex)[order]
V(GA)$birthyear<-GA_nodes$birthyear[order]
V(GA)$race<-as.character(GA_nodes$race)[order]
V(GA)$position<-as.character(GA_nodes$position)[order]
V(GA)$season<-GA_nodes$season[order]
V(GA)$sign<-as.character(GA_nodes$sign)[order]

#Ho pasam a tipus "network" per poder emprar ERGM.
GAnetwork=as.network(as.matrix(as_adjacency_matrix(GA)),directed=FALSE)
V(GA)$sex=as.factor(V(GA)$sex)
network::set.vertex.attribute(GAnetwork,"sex", V(GA)$sex)
network::set.vertex.attribute(GAnetwork,"birthyear", V(GA)$birthyear)
network::set.vertex.attribute(GAnetwork,"race", V(GA)$race)
network::set.vertex.attribute(GAnetwork,"position", V(GA)$position)
network::set.vertex.attribute(GAnetwork,"season", V(GA)$season)
network::set.vertex.attribute(GAnetwork,"sign", V(GA)$sign)
```

Cream el model amb les variables escollides.
```{r}
mod=ergm(GAnetwork ~ nodematch("sex") + degree(1) + absdiff("birthyear") +
          nodematch("race") + absdiff("season"))
summary(mod5)
```


Per tant, el model resultant és
$$
\begin{array}{rcl}
\log\left( \frac{P(A_{ij}=1|G_{ij}^c)}{P(A_{ij}=0|G_{ij}^c)}\right) &=&  -3.38191  \cdot \Delta(\mbox{nombre de relacions homosexuals})+ 2.23688  \cdot \Delta(\mbox{nombre de nodes de grau 1})\\
&&  -0.14566  \cdot \Delta(\mbox{suma diferències d'edat entre nodes adj.})\\
&&  + 0.62680  \cdot \Delta(\mbox{nombre de relacions entre mateixa raça})\\
&&  -0.30677  \cdot \Delta(\mbox{suma diferències en el nombre de la temporada}).\\
\end{array}
$$



<ul>
**(a)** What is the link in the network with the highest probability (or the links, in the case of ties)? Look up somewhere on the Internet whether the corresponding contact appeared early or late in the series.

**(b)** What is the most probable new (that is, absent from the network) sexual contact between a pair of characters in that network? Look up somewhere on the Internet whether this contact has occurred in the series after season 8, and (if the answer is positive) when.

**(c)** What about an Stochastic Block Model? Fit an “optimal” SBM to this network, and use the result to give an answer to the previous questions.

**(d)** What approach do you consider more reasonable to answer questions **(a)** and **(b)** for this specific
network, the ERGM one or the SBM one? Justify your answer.
</ul>

<br>

###Exercice 5
**5)** (4 points) I want you to design networks where the most central nodes with respect to some set S ofcentrality measures are different.

<ul>
**(a)** Build, by hand, a small network that has this property with respect to S = fdegree; betweennessg. That is, where no node with highest degree is a node with highest betweenness. Plot the network, indicating the nodes of highest degree and of highest betweenness. Explain the strategy you followed to build your network with the desired property.

**(b)** Build, by hand, a small network that has this property with respect to S = fcloseness; betweennessg. Plot the network, indicating the nodes of highest closeness and of highest betweenness. Explain the strategy you followed to build your network with the desired property.

**(c)** Now, write a program that searches the space of all connected networks of a given size n and either finds a network with this property for S = fdegree; betweenness; closeness; eigenvectorg or reports that there is no such network for this n. Run your program starting with n = 4 and provide a smallest network (with least order, and among those with this order, with least size) with this property. Plot the network, indicating which are the nodes with the highest centrality values. What are the features of the network that make the most central nodes according to the different centrality measures to be different? If necessary, to hint the answer to this question, find some more networks with this property.
