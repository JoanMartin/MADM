---
title: "Social and economic networks"
subtitle: "Handout 8"
author: "Juan José Martín y Christian Strasser"
output:
  html_document:
    number_sections: false
    highlight: tango
    toc: yes
    df_print: paged
editor_options: 
  chunk_output_type: console
---



<style type="text/css">

  body {
    background-color: #f6f7fd; 
  }
  
  a:link {
    color: #0174DF;
  }
  
  code.r {
    font-size: 14px;
  } 
  
  div pre {
    background-color:#E0ECF8;
  }
  pre {
    font-size: 14px 
  }
 
  p {
    text-align: justify;
  }
 
    
  h1, h2, h3, h4, h5, h6 {
    color: #737aaa;
  }

  th {  
    background-color:#737aaa;
    color: #FAFAFA;
    padding:5px;
  }
  
  td {
    font-size: 11.5pt;
  } 
  
  tr:nth-child(even){
    background: white;
  }
  
  tr:nth-child(odd){ 
    background-color: #EFF8FB;
  }
</style>

*** 

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=8, fig.height=8, fig.align="center", echo=TRUE, warning=FALSE, message=FALSE,autodep = TRUE,cache=TRUE)
library(ergm)
library(statnet)
library(igraph)
library(knitr)
rm(list=ls())
```


**1)** The files **GA_edges.txt** and **GA_nodes.txt** contain the links and nodes (with several attributes) of the sexual contact network among "Grey's Anatomy" characters (seasons 1-8) collected by A. Leavitt (https://github.com/alexleavitt/SNAinRworkshop). 

**Caution!** There's scarcely anything new under the sun. In particular, in Leavitt's github for his workshop on Social Network Analysis cited above you can find scripts with an analysis of this network with ERGM, you can get inspiration from them, but nothing else than inspiration. For instance: he provides the instructions for solving our points  (d) and (e), you can use them but the conclusions must be your harvest; he uses here and there functions from the Dephi package, you cannot unless you explain carefully what you are doing with them (they are not necessary, here); he uses some cunning parameters for instance to upload his dataframes (which are not our dataframes, but have similar features) of to add colors to the nodes, if you use them you must explain what they do.

Define a network with these data frames, and make sure that its nodes have as attributes at least their names, sex, birthyear, race and position.

```{r}
df_e = read.csv("datasets/GA_edges.txt", sep = "\t")
df_v = read.csv("datasets/GA_nodes.txt", sep = "\t")
g = graph_from_data_frame(df_e, directed = FALSE)
```


```{r}
plot(g)
```

<br>

```{r}
for(i in vertex_attr(g)$name){
  g = set_vertex_attr(g, name = "sex", index = i, value = as.character(df_v[i,2]))
  g = set_vertex_attr(g, name = "race", index = i, value = as.character(df_v[i,3]))
  g = set_vertex_attr(g, name = "birthyear", index = i, value = as.character(df_v[i,4]))
  g = set_vertex_attr(g, name = "position", index = i, value = as.character(df_v[i,5]))
  g = set_vertex_attr(g, name = "season", index = i, value = as.character(df_v[i,6]))
  g = set_vertex_attr(g, name = "sign", index = i, value = as.character(df_v[i,7]))
  g = set_vertex_attr(g, name = "name", index = i, value = as.character(df_v[i,1]))
}
```

```{r}
vertex_attr(g)
```

<br>

El atributo *Sign* tiene valores a nulo, por lo que los asignamos como *Unknown*:

```{r}
V(g)$sign[is.na(V(g)$sign)] = "Unknown"
```

<br>

*a)* Provide a statistical summary of this network (including a suitable statistical description of the nodes' attributes that you use in points (c) and (d) below) and plot it with the nodes labelled with the characters' names and colored with their anatomic sex. 

Datos estadísticos del grafo:

* Order: `r igraph::gorder(g)`. 

* Tamaño: `r igraph::gsize(g)`

* Densidad: `r round(igraph::edge_density(g), 4)`

* Componentes: El número de componentes conexos es `r igraph::components(g)$no` y sus tamaños son `r igraph::components(g)$csize`

* Diámetro: `r igraph::diameter(g)`

* Distancia media: `r mean_distance(g)`

* Transitividad: `r round(igraph::transitivity(g), 4)`

<br>

* Atributo *Sex*:
```{r}
table(factor(V(g)$sex, labels=unique(V(g)$sex)))
```

<br>

* Atributo *Race*:
```{r}
table(factor(V(g)$race, labels=unique(V(g)$race)))
```

<br>

* Atributo *Birthyear*:
```{r}
table(factor(V(g)$birthyear, labels=unique(V(g)$birthyear)))
```

<br>

* Atributo *Position*:
```{r}
table(factor(V(g)$position, labels=unique(V(g)$position)))
```

<br>

* Atributo *Season*:
```{r}
table(factor(V(g)$season, labels=unique(V(g)$season)))
```

<br>

* Atributo *Sign*:
```{r}
table(factor(V(g)$sign, labels=unique(V(g)$sign)))
```

<br>

* Representación gráfica del grafo:
```{r}
plot(g, vertex.color = c("pink","skyblue")[1+(V(g)$sex=="M")])
```

<br>

*b)* Is this network bipartite? Justify your answer and explain its meaning for this specific network.

No se trata de una red bipartida porque existe una relación homosexual que crea un núero impar de cliclos impidiendo poder hacer una agrupación de los nodos de la red en 2 conjuntos U y V que cumplen con las condiciones para ser una red bipartida.??

```{r}
is_bipartite(g)
```

<br>

*c)* If you wanted to test one single character for sexually transmitted infections, who would he/she be? Why?

En una red que muestra las relaciones sexuales entre personas, el personaje más importante a analizar sería aquel nodo con mayor grado, que representa el número de personas con las que ha tenido relaciones.

```{r}
V(g)$name[degree(g)==max(degree(g))]
```

<br>

*d)* Fit an ERGM to this network using as predictors its number of edges and of homosexual relations. Explain the results obtained, and check its goodness of fit.

```{r}
g.net = as.network(as.matrix(as_adjacency_matrix(g)), directed=FALSE)
network::set.vertex.attribute(g.net, "name", V(g)$name)
network::set.vertex.attribute(g.net, "sex", V(g)$sex)
network::set.vertex.attribute(g.net, "birthyear", strtoi(V(g)$birthyear, base=0L))
g.net
```

```{r}
fit_g.net = ergm(g.net ~ edges + nodematch("sex"))
summary(fit_g.net)
```

```{r}
fit.gof_g.net <- gof(fit_g.net)
summary(fit.gof_g.net)
```

<br>

*e)* Add as extra predictors the "monogamy" and difference of age between adjacent nodes (it is done by Leavitt in his workshop). Explain the results obtained, and check its goodness of fit.

```{r}
fit2_g.net <- ergm(g.net~edges+nodematch("sex")+degree(1)+absdiff("birthyear"))
summary(fit2_g.net)
```
```{r}
fit2.gof_g.net <- gof(fit2_g.net)
summary(fit2.gof_g.net)
```

<br>

*f)* Try at least one more model that you consider interesting and that you think could explain better the network (you can add predictors to (e) and remove predictors from it; it is forbidden to use anything related to transitivity, because of (g) below). Justify your choice, explain the results obtained and check whether it fits better the network.

```{r}

```

<br>

*g)*  What is a triangle in this network? Test the transitivity and the average clustering of this network with the previous models. Explain your results.

Un triángulo en esta red no dirigida representa un grupo de tres nodos que forman un clico entre sí, es decir, un grupo de tres presonas donde al menos dos de ellas tienen el mismo sexo y han tenido una relación sexual.

Coeficiente de clustering:
```{r}
round(transitivity(g, type="average"), 4)
```

<br>

Coeficiente de transitividad:
```{r}
round(transitivity(g), 4)
```

En esta red no dirigida no existe ningún ciclo entre tres nodos. Aunque sí existen relaciones homosexuales en esta red, estos nodos no forman ningún ciclo con otro nodo, lo cual explica que tanto el coeficiente de clustering, como el coeficiente de transitividad dan 0.

<br>

*h)* P. S. Bearman, J. Moody and K. Stovel (in their classic "Chains of affection: The structure of adolescent romantic and sexual networks" (*Am. J. Soc.* 110 (2004), 44-91) on romantic relations in a High School which we have mentioned several times in the course) found a prohibition against coupling with a former partner's former partner's former partner (and justified it on the basis status implications). Check whether this network satisfies this prohibition, and test it on the previous models.

Para analizar si nuestra red sigue o no el estudio de "_Chains of affection_" simplemente hay que mirar cuantos ciclos de 4 nodos existen en la red, que corresponde a un caso donde NO se cumple el estudio de "_Chains of affection_". 

```{r}
cycles = kcycle.census(dat = get.adjacency(g, type = c("both"), attr = NULL, sparse = FALSE), maxlen = 4, tabulate.by.vertex = FALSE, mode = "graph")
cycles
```

```{r}
(4*cycles$cycle.count[3])/(nrow(df_v))
```

```{r}
(4*cycles$cycle.count[3])/gsize(g)
```

```{r}
(cycles$cycle.count[3])/gsize(g)
```

modedlo estocastico para predecir un enlace.